window.Pelagios=window.Pelagios||{},Pelagios.Draggable={makeXDraggable:function(e,t,a,o){var n=function(e){var t,a=e.changedTouches[0],o=document.createEvent("MouseEvent");if("touchstart"===e.type)t="mousedown";else if("touchmove"===e.type)t="mousemove";else{if("touchend"!==e.type)return;t="mouseup"}o.initMouseEvent(t,!0,!0,window,1,a.screenX,a.screenY,a.clientX,a.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(o),e.preventDefault()};("ontouchstart"in window||navigator.MaxTouchPoints>0)&&(e[0].addEventListener("touchstart",n,!0),e[0].addEventListener("touchmove",n,!0),e[0].addEventListener("touchend",n,!0),e[0].addEventListener("touchcancel",n,!0)),e.draggable({axis:"x",containment:o,drag:t,stop:a})}},window.Pelagios=window.Pelagios||{},Pelagios.Formatting={formatYear:function(e){var t=e instanceof Date?e.getFullYear():parseInt(e);return t<0?-t+" BC":t+" AD"}},window.Pelagios=window.Pelagios||{},Pelagios.HasEvents=function(){this.handlers={}},Pelagios.HasEvents.prototype.on=function(e,t){var a=this.handlers[e]||[];a.push(t),this.handlers[e]=a},Pelagios.HasEvents.prototype.fireEvent=function(e,t,a){this.handlers[e]&&this.handlers[e].forEach(function(e){e(t,a)})},window.Pelagios=window.Pelagios||{},Pelagios.Template=function(e,t){return jQuery('<div class="trs-container"><div class="timerange-selector"><canvas width="'+e+'" height="'+t+'"></canvas><span class="trs-axislabel from"></span><span class="trs-axislabel zero">1 AD</span><span class="trs-axislabel to"></span><div class="trs-selection"></div><div class="trs-handle from"><div class="label"></div></div><div class="trs-handle to"><div class="label"></div></div></div></div>')},window.Pelagios=window.Pelagios||{},Pelagios.TimerangeSelector=function(e){var t,a,o,n,i=this,s=jQuery(e),r=(Pelagios.Template(s.width(),s.height()).appendTo(s),s.find("canvas")),l=s.find(".trs-selection"),c=s.find(".trs-handle.from"),d=c.find(".label"),f=s.find(".trs-handle.to"),g=f.find(".label"),h=s.find(".trs-axislabel.from"),u=s.find(".trs-axislabel.zero"),m=s.find(".trs-axislabel.to"),v=!1,w=!1,p=function(e){var a=(v.to.getFullYear()-v.from.getFullYear()+1)/t;return Math.round(v.from.getFullYear()+e*a)},P=function(e){var a=v.to.getFullYear()-v.from.getFullYear()+1,o=t/a;return Math.round((e-v.from.getFullYear())*o)},b=function(e){return e[Object.keys(e)[0]]},F=function(e){return Object.keys(e)[0]},y=function(){if(!w&&v){var e=Math.max(0,l.position().left)-a,o=p(e),n=Math.min(e+l.outerWidth(),t),i=p(n)-1;o>i&&(i=o),(o>v.from.getFullYear()||i<v.to.getFullYear())&&(w={from:o,to:i})}return w},Y=function(e){var o,i,s=jQuery(e.target).position().left;if(w=!1,e.target===c[0]){if(i=-n-2,o=f.position().left-n,s<i)return c.css("left",i),!1;if(s>o)return c.css("left",o),!1;d.show(),d.html(Pelagios.Formatting.formatYear(p(s+n-a))),l.css("left",s+n),l.css("width",o-s-1)}else{if(i=c.position().left+n+1,o=a+t+2,s<i)return f.css("left",i+1),!1;if(s>o)return f.css("left",o),!1;g.show(),g.html(Pelagios.Formatting.formatYear(p(s-a))),l.css("width",s-i)}},E=function(e){Y(e);var t=y();d.empty(),d.hide(),g.empty(),g.hide(),t?i.fireEvent("changed",t):i.fireEvent("changed",{from:!1,to:!1})},x=function(e){var t=l.position().left-a,o=l.outerWidth(),s=p(t),r=p(t+o);w=!1,d.html(Pelagios.Formatting.formatYear(s)),d.show(),c.css("left",t-n+a),g.html(Pelagios.Formatting.formatYear(r)),g.show(),f.css("left",t+o+a),i.fireEvent("changed",jQuery.extend({},y()))},X=function(e,o){w={from:e,to:o},selectionNewFromX=Math.max(0,P(e)),selectionNewToX=Math.min(P(o+1),t),selectionNewFromX>selectionNewToX&&(selectionNewFromX=selectionNewToX),l.css("left",selectionNewFromX+a),c.css("left",selectionNewFromX+a-n),l.css("width",selectionNewToX-selectionNewFromX),f.css("left",selectionNewToX+a)};d.hide(),g.hide(),o=r[0].getContext("2d"),t=r.outerWidth(!1),a=(r.outerWidth(!0)-t)/2,n=c.outerWidth(),Pelagios.Draggable.makeXDraggable(c,Y,E),Pelagios.Draggable.makeXDraggable(f,Y,E),Pelagios.Draggable.makeXDraggable(l,x,function(e){x(),d.empty(),d.hide(),g.empty(),g.hide()},r),this.update=function(e){if(0!==e.length){var n=function(e){var t=new Date(e);if(0===e.indexOf("-")){var a=e.indexOf("-",1)<0?parseInt(e.substring(1)):parseInt(e.substring(1,e.indexOf("-",1)));t.setFullYear(-a)}return t},i=y(),s=Math.max.apply(Math,e.map(b)),r=n(F(e[0])),l=n(F(e[e.length-1])),c=o.canvas.height-1,d=4,f=o.canvas.width-2*d,g=Math.round(f/e.length),w=g-3;v={from:r,to:l},h.html(Pelagios.Formatting.formatYear(r)),m.html(Pelagios.Formatting.formatYear(l)),r.getFullYear()<0&&l.getFullYear()>0?(u.show(),u[0].style.left=P(0)+a-35+"px"):u.hide(),o.clearRect(0,0,t,o.canvas.height),e.forEach(function(e){var t=b(e),a=Math.round(Math.sqrt(t/s)*c);o.strokeStyle="#3182bd",o.fillStyle="#6baed6",o.beginPath(),o.rect(d+.5,c-a+.5,w,a),o.fill(),o.stroke(),d+=g}),X(i.from,i.to)}},Pelagios.HasEvents.apply(this)},Pelagios.TimerangeSelector.prototype=Object.create(Pelagios.HasEvents.prototype);